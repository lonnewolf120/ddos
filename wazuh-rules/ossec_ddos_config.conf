# Wazuh Active Response Configuration for DDoS Defense
# File: /var/ossec/etc/ossec.conf (Add to existing configuration)

# ============================================================================
# ACTIVE RESPONSE - Automatic DDoS Mitigation
# ============================================================================

<ossec_config>

  <!-- Firewall Block for Critical DDoS Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>101000</rules_id>
    <timeout>3600</timeout> <!-- Block for 1 hour -->
  </active-response>

  <!-- Rate Limiting for HTTP Flood Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100402,100403,100404,100405,100406</rules_id>
    <timeout>1800</timeout> <!-- Block for 30 minutes -->
  </active-response>

  <!-- Block Distributed Attacks Immediately -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100700,100701</rules_id>
    <timeout>7200</timeout> <!-- Block for 2 hours -->
  </active-response>

  <!-- Block SYN Flood Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100101,100102,100103,100104,100105,100106</rules_id>
    <timeout>3600</timeout>
  </active-response>

  <!-- Block UDP Flood Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100201,100202,100203,100204</rules_id>
    <timeout>3600</timeout>
  </active-response>

  <!-- Block ICMP Flood Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100301,100302,100303,100304,100305</rules_id>
    <timeout>3600</timeout>
  </active-response>

  <!-- Block Slowloris Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100501,100502,100503</rules_id>
    <timeout>3600</timeout>
  </active-response>

  <!-- Block IP Spoofing Attacks -->
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>100604</rules_id>
    <timeout>7200</timeout> <!-- Longer block for spoofing -->
  </active-response>

</ossec_config>

# ============================================================================
# EMAIL ALERTS - Security Team Notification
# ============================================================================

<ossec_config>

  <!-- Critical DDoS Alert -->
  <email_alerts>
    <email_to>security-team@cyberrange.local</email_to>
    <level>10</level>
    <group>ddos_attack,critical,</group>
    <do_not_delay/>
  </email_alerts>

  <!-- Distributed Attack Alert -->
  <email_alerts>
    <email_to>security-team@cyberrange.local</email_to>
    <rules_id>100700,100701,100702</rules_id>
    <do_not_delay/>
  </email_alerts>

  <!-- Resource Exhaustion Alert -->
  <email_alerts>
    <email_to>security-team@cyberrange.local</email_to>
    <rules_id>100801,100802</rules_id>
    <do_not_delay/>
  </email_alerts>

</ossec_config>

# ============================================================================
# SYSLOG OUTPUT - Forward to SIEM
# ============================================================================

<ossec_config>

  <!-- Forward DDoS alerts to external SIEM -->
  <syslog_output>
    <level>8</level>
    <server>10.10.10.50</server> <!-- Prometheus/Monitoring Server -->
    <port>514</port>
    <format>splunk</format>
  </syslog_output>

  <!-- Forward to Blue Team SIEM (Wazuh Managers) -->
  <syslog_output>
    <level>8</level>
    <group>ddos_attack</group>
    <server>20.10.40.12</server> <!-- Blue Team 1 SIEM -->
    <port>514</port>
    <format>json</format>
  </syslog_output>

  <syslog_output>
    <level>8</level>
    <group>ddos_attack</group>
    <server>20.10.50.12</server> <!-- Blue Team 2 SIEM -->
    <port>514</port>
    <format>json</format>
  </syslog_output>

  <syslog_output>
    <level>8</level>
    <group>ddos_attack</group>
    <server>20.10.60.12</server> <!-- Blue Team 3 SIEM -->
    <port>514</port>
    <format>json</format>
  </syslog_output>

</ossec_config>

# ============================================================================
# LOG ANALYSIS - Enhanced Monitoring
# ============================================================================

<ossec_config>

  <!-- Monitor Firewall Logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/iptables.log</location>
  </localfile>

  <!-- Monitor Apache/Nginx Logs for HTTP Floods -->
  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/apache2/access.log</location>
  </localfile>

  <localfile>
    <log_format>apache</log_format>
    <location>/var/log/nginx/access.log</location>
  </localfile>

  <!-- Monitor Connection Tracking -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/conntrack.log</location>
  </localfile>

  <!-- Monitor Network Statistics -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/netstat.log</location>
  </localfile>

</ossec_config>

# ============================================================================
# COMMANDS - Custom Active Response Scripts
# ============================================================================

<ossec_config>

  <!-- Custom DDoS Mitigation Script -->
  <command>
    <name>ddos-mitigate</name>
    <executable>ddos-mitigate.sh</executable>
    <timeout_allowed>no</timeout_allowed>
  </command>

  <!-- Rate Limit HTTP Requests -->
  <command>
    <name>http-rate-limit</name>
    <executable>http-rate-limit.sh</executable>
    <timeout_allowed>no</timeout_allowed>
  </command>

  <!-- SYN Cookie Activation -->
  <command>
    <name>enable-syn-cookies</name>
    <executable>enable-syn-cookies.sh</executable>
    <timeout_allowed>no</timeout_allowed>
  </command>

</ossec_config>

# ============================================================================
# FREQUENCY TUNING - Adjust Detection Thresholds
# ============================================================================

# These values can be adjusted based on your environment:

# SYN Flood Detection:
# - Rule 100101: 50 packets in 10 seconds (adjust for false positives)
# - Rule 100102-106: 100 packets in 10 seconds per port

# UDP Flood Detection:
# - Rule 100201: 100 packets in 10 seconds
# - Rule 100202-204: 150 packets in 10 seconds per port

# ICMP Flood Detection:
# - Rule 100301: 50 packets in 10 seconds
# - Rule 100302: 200 packets in 10 seconds

# HTTP Flood Detection:
# - Rule 100401: 50 requests in 10 seconds
# - Rule 100402-406: 100 requests in 10 seconds per port

# Slowloris Detection:
# - Rule 100501: 20 connections in 60 seconds
# - Rule 100502-503: 30 connections in 60 seconds per port

# IP Spoofing Detection:
# - Rule 100603: 10 spoofed IPs in 5 seconds
# - Rule 100604: 50 spoofed packets in 10 seconds

# Distributed Attack Detection:
# - Rule 100700: 5 different sources in 10 seconds
# - Rule 100701: 3 botnet sources in 5 seconds
